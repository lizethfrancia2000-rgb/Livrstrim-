<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cortador de Videos - Clips de 1 minuto</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 0.5em;
    }
    input[type=file] {
      background: #1f1f1f;
      border: none;
      padding: 10px 15px;
      color: #eee;
      border-radius: 6px;
      cursor: pointer;
    }
    input[type=text] {
      margin-top: 10px;
      padding: 10px;
      width: 300px;
      border-radius: 6px;
      border: none;
      background: #1f1f1f;
      color: #eee;
      font-size: 1rem;
    }
    button {
      margin-top: 15px;
      padding: 12px 25px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #2563eb;
    }
    #clips {
      margin-top: 30px;
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .clip {
      background: #1f1f1f;
      border-radius: 10px;
      padding: 10px;
      width: calc(50% - 15px);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    video {
      width: 100%;
      border-radius: 8px;
      background: black;
    }
    a.download-link {
      color: #3b82f6;
      font-weight: 600;
      text-decoration: none;
    }
    a.download-link:hover {
      text-decoration: underline;
    }
    #progress {
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      height: 18px;
      display: none;
    }
    #progress-bar {
      height: 100%;
      width: 0;
      background: #3b82f6;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

  <h1>Cortador de Video en Clips de 1 Minuto</h1>
  <input type="file" id="videoInput" accept="video/*" />
  <input type="text" id="overlayText" placeholder="Texto que aparecerá en cada clip" />

  <button id="processBtn" disabled>Procesar Video</button>

  <div id="progress">
    <div id="progress-bar"></div>
  </div>

  <div id="clips"></div>

  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const videoInput = document.getElementById('videoInput');
    const processBtn = document.getElementById('processBtn');
    const clipsContainer = document.getElementById('clips');
    const overlayTextInput = document.getElementById('overlayText');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress');

    let videoFile;
    let videoDuration = 0;

    videoInput.addEventListener('change', async (e) => {
      clipsContainer.innerHTML = '';
      overlayTextInput.value = '';
      processBtn.disabled = true;

      if (e.target.files.length > 0) {
        videoFile = e.target.files[0];

        // Obtener duración del video
        const url = URL.createObjectURL(videoFile);
        const tempVideo = document.createElement('video');
        tempVideo.preload = 'metadata';
        tempVideo.src = url;
        tempVideo.onloadedmetadata = () => {
          videoDuration = tempVideo.duration;
          URL.revokeObjectURL(url);
          processBtn.disabled = false;
        };
      }
    });

    processBtn.addEventListener('click', async () => {
      if (!videoFile) return;
      processBtn.disabled = true;
      clipsContainer.innerHTML = '';
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      if (!ffmpeg.isLoaded()) {
        await ffmpeg.load();
      }

      const inputName = 'input_video' + videoFile.name.match(/\.\w+$/)[0];
      ffmpeg.FS('writeFile', inputName, await fetchFile(videoFile));

      // Cortar en clips de 60 segundos (1 minuto)
      const clipsCount = Math.ceil(videoDuration / 60);
      const overlayText = overlayTextInput.value.trim();

      for (let i = 0; i < clipsCount; i++) {
        const start = i * 60;
        const duration = (start + 60) > videoDuration ? videoDuration - start : 60;

        // Archivo salida
        const outputName = `clip_${i + 1}.mp4`;

        // Comando ffmpeg para cortar y añadir texto:
        // Drawtext requiere fuente instalada o una fuente estándar.
        // Aquí usamos drawtext para superponer texto en la parte inferior del video.
        const drawTextCmd = overlayText
          ? `-vf drawtext=text='${overlayText}':fontcolor=white:fontsize=24:box=1:boxcolor=black@0.5:boxborderw=5:x=(w-text_w)/2:y=h-40`
          : '';

        await ffmpeg.run(
          '-ss', `${start}`,
          '-t', `${duration}`,
          '-i', inputName,
          '-c:v', 'libx264',
          '-preset', 'fast',
          '-c:a', 'aac',
          ...(overlayText ? ['-vf', `drawtext=text='${overlayText}':fontcolor=white:fontsize=24:box=1:boxcolor=black@0.5:boxborderw=5:x=(w-text_w)/2:y=h-40`] : []),
          outputName
        );

        // Leer archivo generado
        const data = ffmpeg.FS('readFile', outputName);

        // Crear blob para video
        const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
        const videoUrl = URL.createObjectURL(videoBlob);

        // Mostrar clip y link de descarga
        const clipElem = document.createElement('div');
        clipElem.className = 'clip';
        clipElem.innerHTML = `
          <video controls src="${videoUrl}"></video>
          <a class="download-link" href="${videoUrl}" download="${outputName}">Descargar Clip ${i + 1}</a>
        `;
        clipsContainer.appendChild(clipElem);

        // Actualizar barra progreso
        const progressPercent = Math.round(((i + 1) / clipsCount) * 100);
        progressBar.style.width = `${progressPercent}%`;
      }

      progressContainer.style.display = 'none';
      processBtn.disabled = false;
      alert('¡Procesamiento completado! Puedes descargar los clips.');
    });
  </script>

</body>
</html>
